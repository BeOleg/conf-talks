# Auth with GraphQL

Сперва разберемся с самым каверзным вопросом, который звучит на собеседованиях — что такое Аутентификация, Идентификация и Авторизация.

**Аутентификация** — процедура проверки подлинности пользователя путём сравнения введённого им логина и пароля.

**Идентификация** — процедура распознания пользователя по токену или кукам.

**Авторизация** — процедура проверки прав доступа к ресурсам на выполнение определённых действий.

Как обычно происходит дело на практике:

- пользователь вводит логин и пароль
- сервер производит аутентификацию и если все окей, то возвращает либо токен, либо индетификатор сессии через куки
- при выполнении какого-либо действия над данными, сервер должен:
  - произвести индетификацию пользователя по токену, либо сессии
  - произвести авторизацию по таблице ACL — проверить права доступа для индетифицированного пользователя
  - если авторизация пройдена, то перейти к операции над данными

## Sign In (Аутентификация)

TODO:

## JWT, cookie (Идентификация)

TODO:

## Прикручиваем ACL (Авторизация)

TODO:

- на уровне сервера
- на уровне схемы
- на уровне связей между типами

## Почему я использую три токена (user, account, admin)

В большинстве случаев разработчики пользуется всего одним токеном при работе с сервером. Долгим и мучительным рефакторингом я для себя вынес одно великое правило, что надо использовать 3 токена:

- `user` — чтобы индетифицировать текущего пользователя, который ввел логин и пароль. Никакие данные я обычно с id-шником пользователя не храню; для этого использую понятие аккаунт.
- `account` — чтобы индетифицировать доступ к каким-то данным. Например: какой-то менеджер регистрирует личный кабинет, через полгода увольняется; на его место приходит новый менеджер, и теперь везде надо перебивать старое мыло пользователя на новое. Чтоб избежать этого бардака, я для себя вынес правило, что юзеры это ненадежный материал, [bus factor](https://ru.wikipedia.org/wiki/%D0%A4%D0%B0%D0%BA%D1%82%D0%BE%D1%80_%D0%B0%D0%B2%D1%82%D0%BE%D0%B1%D1%83%D1%81%D0%B0) никто не отменял. Поэтому все данные храню в каком-то аккаунте, а вот пользователя (`user`) уже прикрепляю к какому-то аккаунту (`account`). Еще часто бывает так, что к одному аккаунту (набору данных) хотят иметь доступ разные пользователи и подход с `user` и `account` как раз ложиться в этот сценарий.
- `admin` — чтобы индетифицировать админа системы. Во-первых хреново путать админа и юзера в один токен, кто-нибудь из прогеров накосячит и все пользователи начнут иметь доступ ко всему (станут админами). Во-вторых частенько требуется, чтобы админ мог зайти в аккаунт пользователя и посмотреть его глазами что у него происходит в личном кабинете (для этого к запросу админа надо просто присандалить токен юзера и аккаунта). Т.е. админ должен легко получать через админку токены `user` и `account` и уже в стандартном публичном интерфейсе ковыряться как пользователь. А в закрытую админскую часть ходить только под токеном `admin`.

Вот три таких нехитрых токена позволяют хорошо запроектировать доступ данным в вашем приложении. Пользуйтесь на здоровье.
