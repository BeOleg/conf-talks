# –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø

-----

### –ß—Ç–æ —Ç–∞–∫–æ–µ...

|                    | <!-- .element: class="fragment" data-fragment-index="1" -->|
|--------------------|----------------------|
| **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** | –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—É—Ç—ë–º —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –≤–≤–µ–¥—ë–Ω–Ω–æ–≥–æ –∏–º –ª–æ–≥–∏–Ω–∞ –∏ –ø–∞—Ä–æ–ª—è. <!-- .element: class="fragment" data-fragment-index="1" --> |
| **–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**  | –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —Ç–æ–∫–µ–Ω—É, —Å–µ—Å—Å–∏–∏ –∏–ª–∏ –∫—É–∫–∞–º. <!-- .element: class="fragment" data-fragment-index="1" --> |
| **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è**    | –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ—Å—É—Ä—Å–∞–º –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π. <!-- .element: class="fragment" data-fragment-index="1" --> |

-----

## 1. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è ‚Äî Sign In

- **–ë–µ–∑ GraphQL**
  - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å —á–µ—Ä–µ–∑ —Å—Ç–∞—Ä—ã–π –¥–æ–±—Ä—ã–π POST, –ø–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω
  - –∏—Å–ø–æ–ª—å–∑—É–µ–º OAuth, –ø–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω

- **–ß–µ—Ä–µ–∑ GraphQL**
  - –∫—Ä—É—Ç–∏–º query –∏–ª–∏ mutation, —á–µ—Ä–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –ø–µ—Ä–µ–¥–∞–µ–º –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å –≤ —Ä–µ—Å–ø–æ–Ω—Å–µ –ø–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω; –ø–ª—é—Å —Å—Ä–∞–∑—É –º–æ–∂–µ–º –ø–æ–ª—É—á–∏—Ç—å –≤–∞–≥–æ–Ω –¥–∞–Ω–Ω—ã—Ö

-----

## –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¢–û–ö–ï–ù

-----

## 2. –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è ‚Äî JWT, cookie

<br/>

### –í –º–∏—Ä–µ GraphQL –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤ —Å–∏–ª—å–Ω–æ –ø—Ä–∏–∂–∏–ª—Å—è [JWT](https://jwt.io/)

<br/>

–ß–∏—Ç–∞—Ç—å –ø—Ä–æ JSON Web Token –≤ [–≤–∏–∫–∏–ø–µ–¥–∏–∏](https://ru.wikipedia.org/wiki/JSON_Web_Token).

-----

## JWT-—Ç–æ–∫–µ–Ω —Å–æ—Å—Ç–æ–∏—Ç –∏–∑:

<p style="font-size: 2em">
<span style="color: #00b9f1" class="fragment" data-fragment-index="1">header</span>.<span style="color: #d63aff" class="fragment" data-fragment-index="2">payload</span>.<span style="color: #fb015b" class="fragment" data-fragment-index="3">sign</span>
</p>

**–ü—Ä–∏–º–µ—Ä:**

<span style="color: #00b9f1" class="fragment" data-fragment-index="1">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.</span>
<br/><span style="color: #d63aff" class="fragment" data-fragment-index="2">eyJzdWIiOjEsImlhdCI6MTU0MTI1MDE2M30.</span>
<br/><span style="color: #fb015b" class="fragment" data-fragment-index="3">M7xYg8GuEgwbqTrta0xnN7WmNEXOCKiQGDdogt_Kduk</span>

**–í–Ω—É—Ç—Ä—è–Ω–∫–∞**

<span style="color: #00b9f1" class="fragment" data-fragment-index="1">base64({ "alg": "HS256", "typ": "JWT" }).</span>
<br/><span style="color: #d63aff" class="fragment" data-fragment-index="2">base64({ "sub": 1, "iat": 1541250163 }).</span>
<br/><span style="color: #fb015b" class="fragment" data-fragment-index="3">HMACSHA256(base64UrlEncode(header) + "." + base64UrlEncode(payload), JWT_SECRET_KEY)</span>

-----

## C JWT –ª–µ–≥–∫–æ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

```js
import jwt from 'jsonwebtoken';

const JWT_SECRET_KEY = 'qwerty ;)';

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞
const token = jwt.sign({ sub: 2 }, JWT_SECRET_KEY);

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞
const payload = jwt.verify(token, JWT_SECRET_KEY);
// { "sub": 1, "iat": 1541250163 }
// sub - —ç—Ç–æ subject, –Ω–∞–ø—Ä–∏–º–µ—Ä id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
// iat - —ç—Ç–æ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–∞
// –∞ –µ—â–µ –µ—Å—Ç—å `iss`, `aud`, `exp`, `nbf`, `jti` - —Å–º–æ—Ç—Ä–∏ —Å–ø–µ–∫—É

```

-----

## –ì–¥–µ —Ö—Ä–∞–Ω–∏—Ç—å –¢–û–ö–ï–ù –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ?

<br />

- `–ï—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä` ‚Äî —Ç–æ –≤ –∫—É–∫–∞—Ö —Å —Ñ–ª–∞–≥–æ–º httpOnly
  - –¥–µ–ª–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –±—ç–∫–µ–Ω–¥–µ—Ä–æ–º, —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ—Ä—É –Ω–∏—á–µ–≥–æ –¥–µ–ª–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ <!-- .element: class="fragment" -->
  - –µ—Å–ª–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ—Ä –≤ –±—Ä–∞—É–∑–µ—Ä–µ —Ö–æ—Ç—å –∫–∞–∫-—Ç–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç —Ç–æ–∫–µ–Ω, —Ç–æ –ø—Ä–∏–≤–µ—Ç XSS ‚ò†Ô∏è <!-- .element: class="fragment" -->
- `–ï—Å–ª–∏ –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ` ‚Äî —Ç–æ –≤ "AsyncStorage"
  - –ø–µ—Ä–µ–¥–∞–µ–º —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ HTTP-–∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å –∫–∞–∂–¥—ã–º –∑–∞–ø—Ä–æ—Å–æ–º <!-- .element: class="fragment" -->

-----

## ‚òùÔ∏è –ü—Å—Å—Å, –ë—ç–∫–µ–Ω–¥–µ—Ä! ‚òùÔ∏è

### –¢—ã –¥–æ–ª–∂–µ–Ω:

- —É–º–µ—Ç—å –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∏ —Å—Ç–∞–≤–∏—Ç—å —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ httpOnly –∫—É–∫–∏
- –∞ –µ—Å–ª–∏ —Ç–∞–º –ø—É—Å—Ç–æ, —Ç–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤ HTTP-–∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö
- –∏–Ω–∞—á–µ –ò–Ω–¥–µ—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ –ø—Ä–æ—à–ª–∞ –∏ –ø–µ—Ä–µ–¥ —Ç–æ–±–æ–π –∞–Ω–æ–Ω–∏–º üëª

-----

## 3. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ‚Äî –ü—Ä–∏–∫—Ä—É—á–∏–≤–∞–µ–º ACL

–ï–µ –º–æ–∂–Ω–æ –∏ –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –Ω–∞ —Å–ª–µ–¥—É—é—â–∏—Ö —É—Ä–æ–≤–Ω—è—Ö:

- –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞ (apollo, express, koa –∏ –ø—Ä.)
- –Ω–∞ —É—Ä–æ–≤–Ω–µ GraphQL-—Å—Ö–µ–º—ã (–≥–ª–æ–±–∞–ª—å–Ω–æ –Ω–∞ –ø–µ—Ä–≤—ã—Ö –ø–æ–ª—è—Ö —Å—Ö–µ–º—ã)
- –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–æ–ª–µ–π (–≤ resolve –º–µ—Ç–æ–¥–∞—Ö)
- –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–≤—è–∑–µ–π –º–µ–∂–¥—É —Ç–∏–ø–∞–º–∏ (–≤ resolve –º–µ—Ç–æ–¥–∞—Ö)

-----

## 3.1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞ (apollo, express, koa –∏ –ø—Ä.)

- —Å—á–∏—Ç–∞—Ç—å —Ç–æ–∫–µ–Ω –∏–∑ –∫—É–∫, –ª–∏–±–æ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
- –ø—Ä–æ–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω –∏ –ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∏–Ω–¥–µ—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ø–µ—Ä–µ–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ `context` graphql
- –ª–∏–±–æ –∑–∞–≤–µ—Ä–Ω—É—Ç—å –∑–∞–ø—Ä–æ—Å, –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–∞–Ω–µ–Ω

-----

### –ü–∏—à–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–º–æ–≥–∞–π–∫—É –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ä–µ–∫–≤–µ—Å—Ç–∞:

```js
async function getUserFromReq(req: $Request) {
  const token = req?.cookies?.token || req?.headers?.authorization;
  if (token) {
    const payload = jwt.verify(token, JWT_SECRET_KEY);
    const userId = payload?.sub;
    if (userId) {
      const user = await users.find(userId);
      if (user) {
        if (user.isBanned) throw new Error('Looser!');
        return user;
      }
    }
  }
  return null;
}

```

<span class="fragment" data-code-focus="2" />
<span class="fragment" data-code-focus="4" />
<span class="fragment" data-code-focus="7" />
<span class="fragment" data-code-focus="9,10,14" />

-----

### –ù—É –∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Ñ–æ—Ä–º–∏—Ä—É–µ–º GraphQL-–∫–æ–Ω—Ç–µ–∫—Å—Ç

```js
const server = new ApolloServer({
  schema,
  context: async ({ req }) => {
    let user;
    try {
      user = await getUserFromReq(req);
    } catch (e) {
      throw new AuthenticationError('You provide incorrect token!');
    }
    const role = user?.role || 'GUEST';
    return { req, user, role };
  },
});

```

<span class="fragment" data-code-focus="3" />
<span class="fragment" data-code-focus="6" />
<span class="fragment" data-code-focus="8" />
<span class="fragment" data-code-focus="10" />
<span class="fragment" data-code-focus="11" />

- –ö–æ–Ω—Ç–µ–∫—Å—Ç —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ http-–∑–∞–ø—Ä–æ—Å–∞ –ø–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ –Ω–∞—á–Ω–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è GraphQL-–∑–∞–ø—Ä–æ—Å
- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ req, user –∏ role –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –∞–≥—Ä—É–º–µ–Ω—Ç–µ context –≤–æ –≤—Å–µ—Ö –º–µ—Ç–æ–¥–∞—Ö resolve(source, args, `context`)

-----

## 3.2. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ GraphQL-—Å—Ö–µ–º—ã

## (–≥–ª–æ–±–∞–ª—å–Ω–æ –Ω–∞ –ø–µ—Ä–≤—ã—Ö –ø–æ–ª—è—Ö —Å—Ö–µ–º—ã)

-----

-----

-----